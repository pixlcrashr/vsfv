<html>
    <head>
        <style>
html, body {
  margin: 0;
  padding: 0;
  font-family: Arial, sans-serif;
}

/* TABLE LAYOUT */
table {
  border-collapse: collapse;
  font-size: 8pt;
  border: 1 px solid black !important;
  margin: 0;                   /* no extra margin that would cause overflow */
}

/* Header appearance */
table thead {
  background: #f0f0f0;
}

/* Cells */
table th,
table td {
  border: none;
  padding: 2px 4px;
  vertical-align: top;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.fw-bold {
  font-weight: 600;
}

.fw-normal {
  font-weight: normal;
}

.align-bottom {
  vertical-align: bottom;
}


/* Striping */
tbody tr:nth-child(odd) {
  background-color: #f8f9fa;
}

/* Special cells */
.prefix-cell {
  min-width: 20px !important;
}

.value-cell {
  min-width: 80px !important;
}

.description-cell {
  max-width: 200px;
}

.empty-row {
  height: 18px;
}

/* Amount cells: keep as small as needed and right-align */
.amount-cell {
  white-space: nowrap;
  text-align: right;
}

/* Fallback for Bootstrap-like utility class used in markup */
.text-end {
  text-align: right;
}

.text-nowrap {
  white-space: nowrap;
}

/* Border color helpers */
.b-black {
  border: 1px solid #000;
}

.b-grey {
  border: 1px solid #999;
}

.bt-black {
  border-top: 1px solid #000;
}

.bt-grey {
  border-top: 1px solid #999;
}

.br-black {
  border-right: 1px solid #000;
}

.br-grey {
  border-right: 1px solid #999;
}

.bb-black {
  border-bottom: 1px solid #000;
}

.bb-grey {
  border-bottom: 1px solid #999;
}

.bl-black {
  border-left: 1px solid #000;
}

.bl-grey {
  border-left: 1px solid #999;
}

/* PRINT RULES */
@media print {
  @page {
    size: A3 landscape;
    margin-top: 2.5cm;
    margin-bottom: 2.5cm;

    /* CSS Paged Media margin boxes - works in PDF generators like wkhtmltopdf/WeasyPrint */
    @top-left {
      content: 'Haushaltsübersicht';
      font-size: 8pt;
    }

    @bottom-left {
      content: 'Studierendenschaft der TUHH\A Am Schwarzenberg-Campus 3\A 21073 Hamburg';
      white-space: pre-wrap;
      font-size: 8pt;
    }

    @bottom-right {
      content: counter(page) ' von ' counter(pages);
      font-size: 8pt;
    }
  }

  /* Make thead behave as repeating header */
  thead {
    display: table-header-group;
  }
  tfoot {
    display: table-footer-group;
  }

  /* Do NOT forbid page-breaks inside the whole row:
     that can force the entire wide row to stay on a single page and be clipped.
     We only avoid breaking inside the header/footer blocks themselves. */
  thead, tfoot {
    page-break-inside: avoid;
  }

  /* Allow table rows/cells to break horizontally onto the next page if needed */
  tr, th, td {
    page-break-inside: auto;
  }

  /* Remove any scaling: scaling keeps everything on the same page width
     and will never create an extra page for the rightmost columns. */
  body {
    transform: none;
  }
}
        </style>
    </head>
    <body>
<table>
  <thead>
    <tr>
      <th colspan="{{maxAccountDepth}}" class="fw-bold align-bottom br-black">
        Konto / Titel
      </th>

      {{#if @root.options.accountDescriptionsEnabled}}
        <th class="align-bottom description-cell br-black">
          Anmerkung / Beschreibung
        </th>
      {{/if}}

      {{!-- First header row: budgets --}}
      {{#each budgets}}
        <th
          colspan="{{budgetColspan revisions.length}}"
          class="fw-bold text-nowrap align-bottom text-center {{#unless @last}}br-black{{/unless}}"
        >
          {{name}}
          {{#if @root.options.budgetDescriptionsEnabled}}
            <br />
            <small>{{description}}</small>
          {{/if}}
        </th>
      {{/each}}
    </tr>

    <tr>
      {{#times maxAccountDepth}}
        <th class="prefix-cell"></th>
      {{/times}}
      {{#if @root.options.accountDescriptionsEnabled}}
        <th class="bl-black br-black"></th>
      {{/if}}
      {{!-- Second header row: revision groups --}}
      {{#each budgets}}
        {{#each revisions}}
          <th
            colspan="{{countTrue @root.options.targetValuesEnabled @root.options.actualValuesEnabled @root.options.differenceValuesEnabled}}"
            class="align-bottom text-center {{#unless @root.options.accountDescriptionsEnabled}}{{#if @../first}}{{#if @first}}bl-black{{/if}}{{/if}}{{/unless}} {{#if @../last}}{{#if @last}}{{else}}br-black{{/if}}{{else}}br-black{{/if}}"
          >
            <span class="text-nowrap">
              {{name}}<br />
              {{formatDateShort date}}
            </span>
            {{#if @root.options.budgetDescriptionsEnabled}}
              <br />
              <span class="fw-normal"><small>{{description}}</small></span>
            {{/if}}
          </th>
        {{/each}}
      {{/each}}
    </tr>

    <tr class="bb-black">
      {{#times maxAccountDepth}}
        <th class="prefix-cell"></th>
      {{/times}}
      {{#if @root.options.accountDescriptionsEnabled}}
        <th class="bl-black br-black"></th>
      {{/if}}
      {{#each budgets}}
        {{#each revisions}}
          {{#if @root.options.targetValuesEnabled}}
            <th class="fw-bold align-bottom value-cell {{#if @../first}}
  {{#if @first}}
    {{#unless @root.options.accountDescriptionsEnabled}}
      bl-black
    {{/unless}}
  {{else}}
    bl-black
  {{/if}}
{{else}}
  bl-black
{{/if}}">
              <p class="text-nowrap">Soll</p>
            </th>
          {{/if}}
          {{#if @root.options.actualValuesEnabled}}
            <th class="fw-bold align-bottom value-cell {{#if @root.options.targetValuesEnabled}}
  bl-grey
{{else}}
  bl-black
{{/if}}">
              <p class="text-nowrap">Ist</p>
            </th>
          {{/if}}
          {{#if @root.options.differenceValuesEnabled}}
            <th class="fw-bold align-bottom value-cell {{#if @root.options.targetValuesEnabled}}
  {{#if @root.options.actualValuesEnabled}}
    bl-grey
  {{else}}
    bl-black
  {{/if}}
{{else}}
  bl-black
{{/if}}">
              <p class="text-nowrap">Diff.</p>
            </th>
          {{/if}}
        {{/each}}
      {{/each}}
    </tr>
  </thead>

  <tbody>
    {{!--
      The top-level "accounts" passed to renderReport are wrapper root nodes.
      We only render their children as visible rows, using Account.depth for
      indentation:

      - depth 1  -> 0 prefix cells
      - depth 2  -> 1 prefix cell
      - ...

      maxAccountDepth is the maximum Account.depth among all visible nodes and
      equals the number of Konto/Titel columns.
    --}}
    {{#each accounts}}
      {{#each children}}
        {{> rowFragment node=this }}
      {{/each}}
    {{/each}}
  </tbody>
</table>

{{!--
  Inline partial for a full logical "row fragment" including:
  - the main account row
  - recursive rendering of children
  - (optionally) a simple Σ row

  NOTE: With only the given interfaces, the very specific Angular rules
  like "children.length === 1 && depth === accountColSpan - 1" and advanced
  Σ‑logic cannot be reproduced 1:1 without extra flags from TS.
  Here we implement a **simplified but structurally similar** variant:

  - One visual row per Account.
  - Indentation by recursion depth.
  - One value cell per (budgetRevision, account).
  - A very simple Σ row that sums children under a non‑leaf account
    (using the parent account id as the Σ target).
--}}

{{#*inline "rowFragment"}}
  {{!-- MAIN ROW FOR THIS NODE --}}
  <tr>
    {{#if (subtract node.depth 1)}}
      <td class="prefix-cell" colspan="{{subtract node.depth 1}}"></td>
    {{/if}}

    {{!-- Total Konto/Titel columns = maxAccountDepth.
         Content span = maxAccountDepth - (depth - 1). --}}
    <td colspan="{{subtract @root.maxAccountDepth (subtract node.depth 1)}}" class="align-bottom">
      {{#if node.isLeaf }}
        {{node.code}} – {{node.name}}
      {{else}}
        <b>{{node.code}} – {{node.name}}</b>
      {{/if}}
    </td>

    {{#if @root.options.accountDescriptionsEnabled}}
      <td class="bl-black br-black description-cell align-bottom">
        {{node.description}}
      </td>
    {{/if}}

    {{!-- Per (budget, revision) we now have up to three separate cells: first all Soll, then all Ist, then all Diff --}}
    {{#with node.id as |accountId|}}
      {{#each @root.budgets}}
        {{#each revisions}}
          {{#if @root.options.targetValuesEnabled}}
            <td class="amount-cell text-end align-bottom {{#if @../first}}
  {{#if @first}}
    {{#unless @root.options.accountDescriptionsEnabled}}
      bl-black
    {{/unless}}
  {{else}}
    bl-black
  {{/if}}
{{else}}
  bl-black
{{/if}}">
              {{#if ../../../node.isLeaf}}{{formatCurrency (getTargetValue id accountId)}}{{/if}}
            </td>
          {{/if}}
          {{#if @root.options.actualValuesEnabled}}
            <td class="amount-cell text-end align-bottom {{#if @root.options.targetValuesEnabled}}
  bl-grey
{{else}}
  bl-black
{{/if}}">
              {{#if ../../../node.isLeaf}}{{formatCurrency (getActualValue ../id accountId)}}{{/if}}
            </td>
          {{/if}}
          {{#if @root.options.differenceValuesEnabled}}
            <td class="amount-cell text-end align-bottom {{#if @root.options.targetValuesEnabled}}
  {{#if @root.options.actualValuesEnabled}}
    bl-grey
  {{else}}
    bl-black
  {{/if}}
{{else}}
  bl-black
{{/if}}">
              {{#if ../../../node.isLeaf}}{{formatCurrency (getDiffValue id accountId)}}{{/if}}
            </td>
          {{/if}}
        {{/each}}
      {{/each}}
    {{/with}}
  </tr>

  {{!-- RECURSE INTO CHILDREN --}}
  {{#if node.children.length}}
    {{#each node.children}}
      {{> rowFragment node=this }}
    {{/each}}

    {{!-- OPTIONAL SIMPLE Σ ROW: sum of children for non‑leaf accounts --}}
    <tr>
      {{#if (subtract node.depth 1)}}
        <td class="prefix-cell" colspan="{{subtract node.depth 1}}"></td>
      {{/if}}

      <td colspan="{{subtract @root.maxAccountDepth (subtract node.depth 1)}}" class="align-bottom br-black">
        <b>Summe Σ ({{node.code}} – {{node.name}})</b>
      </td>

      {{#if @root.options.accountDescriptionsEnabled}}
        <td class="br-black"></td>
      {{/if}}

      {{#with node.id as |accountId|}}
        {{#each @root.budgets}}
          {{!-- Σ row with separate Soll/Ist/Diff blocks, ordered by revision --}}
          {{#each revisions}}
            {{#if @root.options.targetValuesEnabled}}
              <td class="amount-cell align-bottom {{#if @../first}}
  {{#if @first}}
    {{#unless @root.options.accountDescriptionsEnabled}}
      bl-black
    {{/unless}}
  {{else}}
    bl-black
  {{/if}}
{{else}}
  bl-black
{{/if}}">
                <b>{{formatCurrency (getTargetValue id accountId)}}</b>
              </td>
            {{/if}}
            {{#if @root.options.actualValuesEnabled}}
              <td class="amount-cell align-bottom {{#if @root.options.targetValuesEnabled}}
  bl-grey
{{else}}
  bl-black
{{/if}}">
                <b>{{formatCurrency (getActualValue ../id accountId)}}</b>
              </td>
            {{/if}}
            {{#if @root.options.differenceValuesEnabled}}
              <td class="amount-cell align-bottom {{#if @root.options.targetValuesEnabled}}
  {{#if @root.options.actualValuesEnabled}}
    bl-grey
  {{else}}
    bl-black
  {{/if}}
{{else}}
  bl-black
{{/if}}">
                <b>{{formatCurrency (getDiffValue id accountId)}}</b>
              </td>
            {{/if}}
          {{/each}}
        {{/each}}
      {{/with}}
    </tr>

    <tr class="empty-row">
      <td class="prefix-cell" colspan="{{@root.maxAccountDepth}}"></td>

      {{#if @root.options.accountDescriptionsEnabled}}
        <td class="bl-black br-black description-cell align-bottom"></td>
      {{/if}}

      {{#with node.id as |accountId|}}
        {{#each @root.budgets}}
          {{#each revisions}}
            {{#if @root.options.targetValuesEnabled}}
              <td class="{{#if @../first}}
  {{#if @first}}
    {{#unless @root.options.accountDescriptionsEnabled}}
      bl-black
    {{/unless}}
  {{else}}
    bl-black
  {{/if}}
{{else}}
  bl-black
{{/if}}"></td>
            {{/if}}
            {{#if @root.options.actualValuesEnabled}}
              <td class="{{#if @root.options.targetValuesEnabled}}
  bl-grey
{{else}}
  bl-black
{{/if}}"></td>
            {{/if}}
            {{#if @root.options.differenceValuesEnabled}}
              <td class="{{#if @root.options.targetValuesEnabled}}
  {{#if @root.options.actualValuesEnabled}}
    bl-grey
  {{else}}
    bl-black
  {{/if}}
{{else}}
  bl-black
{{/if}}"></td>
            {{/if}}
          {{/each}}
        {{/each}}
      {{/with}}
    </tr>
  {{/if}}
{{/inline}}
    </body>
</html>
