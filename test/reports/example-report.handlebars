<html>
    <head>
        <style>
html, body {
  margin: 0;
  padding: 0;
  font-family: Arial, sans-serif;
}

/* TABLE LAYOUT */
table {
  border-collapse: collapse;
  font-size: 8pt;
  margin: 0;                   /* no extra margin that would cause overflow */
}

/* Header appearance */
table thead {
  background: #f0f0f0;
}

/* Cells */
table th,
table td {
  border: 1px solid #000;
  padding: 2px 4px;
  vertical-align: top;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

/* Striping */
tbody tr:nth-child(odd) {
  background-color: #f8f9fa;
}

/* Special cells */
.prefix-cell {
  min-width: 20px !important;
}

.description-cell {
  max-width: 200px;
}

.empty-row {
  height: 18px;
}

/* Amount cells: keep as small as needed and right-align */
.amount-cell {
  white-space: nowrap;
  text-align: right;
}

/* Fallback for Bootstrap-like utility class used in markup */
.text-end {
  text-align: right;
}

/* PRINT RULES */
@media print {
  @page {
    size: A3 landscape;
  }

  /* Make thead behave as repeating header */
  thead {
    display: table-header-group;
  }
  tfoot {
    display: table-footer-group;
  }

  /* Do NOT forbid page-breaks inside the whole row:
     that can force the entire wide row to stay on a single page and be clipped.
     We only avoid breaking inside the header/footer blocks themselves. */
  thead, tfoot {
    page-break-inside: avoid;
  }

  /* Allow table rows/cells to break horizontally onto the next page if needed */
  tr, th, td {
    page-break-inside: auto;
  }

  /* Remove any scaling: scaling keeps everything on the same page width
     and will never create an extra page for the rightmost columns. */
  body {
    transform: none;
  }
}
        </style>
    </head>
    <body>
        
<table class="border border-black">
  <thead class="border-bottom border-black">
    <tr>
      <th colspan="{{maxAccountDepth}}" rowspan="2" class="fw-bold align-bottom">
        Konto / Titel
      </th>

      {{#if @root.options.accountDescriptionsEnabled}}
        <th rowspan="2" class="border-start border-black align-bottom description-cell">
          Anmerkung / Beschreibung
        </th>
      {{/if}}

      {{!-- First header row: budgets --}}
      {{#each budgets}}
        <th
          colspan="{{budgetColspan revisions.length}}"
          class="fw-bold text-nowrap border-start border-end border-black align-bottom text-center"
        >
          {{name}}
          {{#if @root.options.budgetDescriptionsEnabled}}
            <br />
            <small>{{description}}</small>
          {{/if}}
        </th>
      {{/each}}
    </tr>

    <tr>
      {{!-- Second header row: revisions per budget with Soll/Ist/Diff columns --}}
      {{#each budgets}}
        {{#if @root.options.targetValuesEnabled}}
          {{#each revisions}}
            <th class="fw-bold align-bottom border-start border-end border-black">
              <p class="m-0 text-nowrap">
                Rev {{add @index 1}} Soll
                <span class="font-weight-normal">
                  <br />
                  <i>{{formatDateShort date}}</i>
                </span>
              </p>
            </th>
          {{/each}}
        {{/if}}

        {{#if @root.options.actualValuesEnabled}}
          {{#each revisions}}
            <th class="fw-bold align-bottom border-start border-end border-black">
              <p class="m-0 text-nowrap">
                Rev {{add @index 1}} Ist
                <span class="font-weight-normal">
                  <br />
                  <i>{{formatDateShort date}}</i>
                </span>
              </p>
            </th>
          {{/each}}
        {{/if}}

        {{#if @root.options.differenceValuesEnabled}}
          {{#each revisions}}
            <th class="fw-bold align-bottom border-start border-end border-black">
              <p class="m-0 text-nowrap">
                Rev {{add @index 1}} Diff
                <span class="font-weight-normal">
                  <br />
                  <i>{{formatDateShort date}}</i>
                </span>
              </p>
            </th>
          {{/each}}
        {{/if}}
      {{/each}}
    </tr>
  </thead>

  <tbody>
    {{!--
      The top-level "accounts" passed to renderReport are wrapper root nodes.
      We only render their children as visible rows, using Account.depth for
      indentation:

      - depth 1  -> 0 prefix cells
      - depth 2  -> 1 prefix cell
      - ...

      maxAccountDepth is the maximum Account.depth among all visible nodes and
      equals the number of Konto/Titel columns.
    --}}
    {{#each accounts}}
      {{#each children}}
        {{> rowFragment node=this }}
      {{/each}}
    {{/each}}
  </tbody>
</table>

{{!--
  Inline partial for a full logical "row fragment" including:
  - the main account row
  - recursive rendering of children
  - (optionally) a simple Σ row

  NOTE: With only the given interfaces, the very specific Angular rules
  like "children.length === 1 && depth === accountColSpan - 1" and advanced
  Σ‑logic cannot be reproduced 1:1 without extra flags from TS.
  Here we implement a **simplified but structurally similar** variant:

  - One visual row per Account.
  - Indentation by recursion depth.
  - One value cell per (budgetRevision, account).
  - A very simple Σ row that sums children under a non‑leaf account
    (using the parent account id as the Σ target).
--}}

{{#*inline "rowFragment"}}
  {{!-- MAIN ROW FOR THIS NODE --}}
  <tr>
    {{!-- Indent by (depth - 1) prefix cells so depth 1 starts at column 0 --}}
    {{#times (subtract node.depth 1)}}
      <td class="prefix-cell"></td>
    {{/times}}

    {{!-- Total Konto/Titel columns = maxAccountDepth.
         Content span = maxAccountDepth - (depth - 1). --}}
    <td colspan="{{subtract @root.maxAccountDepth (subtract node.depth 1)}}" class="align-bottom">
      <span class="{{#if node.children.length}}fw-bold{{/if}}">
        {{node.code}} – {{node.name}}
      </span>
    </td>

    {{#if @root.options.accountDescriptionsEnabled}}
      <td class="border-start border-black description-cell align-bottom">
        {{node.description}}
      </td>
    {{/if}}

    {{!-- Per (budget, revision) we now have up to three separate cells: first all Soll, then all Ist, then all Diff --}}
    {{#with node.id as |accountId|}}
      {{#each @root.budgets}}
        {{#if @root.options.targetValuesEnabled}}
          {{#each revisions}}
            <td class="amount-cell text-end align-bottom border-start border-end border-black">
              {{formatCurrency (getTargetValue id accountId)}}
            </td>
          {{/each}}
        {{/if}}

        {{#if @root.options.actualValuesEnabled}}
          {{#each revisions}}
            <td class="amount-cell text-end align-bottom border-start border-end border-black">
              {{formatCurrency (getActualValue ../id accountId)}}
            </td>
          {{/each}}
        {{/if}}

        {{#if @root.options.differenceValuesEnabled}}
          {{#each revisions}}
            <td class="amount-cell text-end align-bottom border-start border-end border-black">
              {{formatCurrency (getDiffValue id accountId)}}
            </td>
          {{/each}}
        {{/if}}
      {{/each}}
    {{/with}}
  </tr>

  {{!-- RECURSE INTO CHILDREN --}}
  {{#if node.children.length}}
    {{#each node.children}}
      {{> rowFragment node=this }}
    {{/each}}

    {{!-- OPTIONAL SIMPLE Σ ROW: sum of children for non‑leaf accounts --}}
    <tr>
      {{#times (subtract node.depth 1)}}
        <td class="prefix-cell"></td>
      {{/times}}

      <td colspan="{{subtract @root.maxAccountDepth (subtract node.depth 1)}}" class="fw-bold align-bottom">
        Summe Σ ({{node.code}} – {{node.name}})
      </td>

      {{#if @root.options.accountDescriptionsEnabled}}
        <td class="border-start border-black"></td>
      {{/if}}

      {{#with node.id as |accountId|}}
        {{#each @root.budgets}}
          {{!-- Σ row with separate Soll/Ist/Diff blocks, ordered by metric then revision --}}
          {{#if @root.options.targetValuesEnabled}}
            {{#each revisions}}
              <td class="amount-cell text-end fw-bold align-bottom border-start border-end border-black">
                {{formatCurrency (getTargetValue id accountId)}}
              </td>
            {{/each}}
          {{/if}}

          {{#if @root.options.actualValuesEnabled}}
            {{#each revisions}}
              <td class="amount-cell text-end fw-bold align-bottom border-start border-end border-black">
                {{formatCurrency (getActualValue ../id accountId)}}
              </td>
            {{/each}}
          {{/if}}

          {{#if @root.options.differenceValuesEnabled}}
            {{#each revisions}}
              <td class="amount-cell text-end fw-bold align-bottom border-start border-end border-black">
                {{formatCurrency (getDiffValue id accountId)}}
              </td>
            {{/each}}
          {{/if}}
        {{/each}}
      {{/with}}
    </tr>
  {{/if}}
{{/inline}}
    </body>
</html>
